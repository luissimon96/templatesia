FROM node:18-alpine AS builder

WORKDIR /app

# Copiar arquivos de configuração
COPY package*.json ./
COPY turbo.json ./
COPY packages/database/package.json ./packages/database/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/tsconfig/package.json ./packages/tsconfig/
COPY apps/api/package.json ./apps/api/

# Instalar dependências
RUN npm install

# Copiar código fonte
COPY . .

# Gerar Prisma Client
RUN cd packages/database && npx prisma generate

# Construir a API
RUN npm run build --workspace=@templatesia/api

FROM node:18-alpine AS runner

WORKDIR /app

# Copiar arquivos necessários do builder
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/packages ./packages
COPY --from=builder /app/apps/api/dist ./apps/api/dist
COPY --from=builder /app/apps/api/package.json ./apps/api/

# Configurar ambiente
ENV NODE_ENV=development
ENV PORT=3001

# Expor porta
EXPOSE 3001

# Iniciar aplicação
CMD ["npm", "run", "dev", "--workspace=@templatesia/api"] 